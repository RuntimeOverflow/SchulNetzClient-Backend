var e,t;(e=>{e[e.Info=0]="Info",e[e.Warn=1]="Warn",e[e.Error=2]="Error",e[e.Fatal=3]="Fatal"})(e||(e={}));class s{constructor(e,t){this.type="Exception",this.func=e,this.message=t}}class n extends s{constructor(){super(...arguments),this.type="ParserException"}}class a extends s{constructor(){super(...arguments),this.type="LinkerException"}}class r extends s{constructor(){super(...arguments),this.type="JavaScriptException"}}function i(e,t){if(!e)throw t}function o(e,t){e||info(t.message)}function c(t,s){if(!t)throw s.level=e.Warn,warn(s.message),s}function d(t,s){if(!t)throw s.level=e.Error,error(s.message),s}function l(t,s){if(!t)throw s.level=e.Fatal,fatal(s.message),s}(e=>{e[e.ABSENCES=21111]="ABSENCES",e[e.TEACHERS=22352]="TEACHERS",e[e.STUDENTS=22348]="STUDENTS",e[e.TRANSACTIONS=21411]="TRANSACTIONS",e[e.GRADES=21311]="GRADES",e[e.SCHEDULE=22202]="SCHEDULE",e[e.DOCUMENT_DOWNLOAD=1012]="DOCUMENT_DOWNLOAD"})(t||(t={}));class h{constructor(e,t,s){this.visitedPageIds=new Set,this._loggedIn=0,this.stateLockQueue=[],this._stableStateRetainCount=0,this.stableStateListeners=[],this._stateChanging=0,this.cookies={},this.sessionTimerRunning=0,this.provider=e,this.username=t,this.password=s}verifyPageAndExtractIds(e){const t=e.querySelector("#header-menu ul[for=sn-main-menu] > li:nth-child(1) > a");i(1==t.length,new n("verifyPageAndExtractIds","dom.querySelector('#header-menu ul[for=sn-main-menu] > li:nth-child(1) > a').length != 1"));const{id:s,transid:a}=extractQueryParameters(t[0].getAttribute("href"),"https://"+this.provider);i(!!s,new n("verifyPageAndExtractIds",`id == null || id == '' (was ${null!=s?"''":void 0})`)),i(!!a,new n("verifyPageAndExtractIds",`transid == null || transid == '' (was ${null!=a?"''":void 0})`)),this.id=s,this.transId=a}hasVisitedPage(e){return this.visitedPageIds.has(e)}set loggedIn(e){this._loggedIn=e}get loggedIn(){return!!(this._loggedIn&&this.id&&this.transId&&null!=this.lastVisitedPageId)}get stateLock(){return this._stateLock}set stateLock(e){if(this._stateLock=e,e)this.stateChanging=1;else{const e=this.stateLockQueue.pop();e?e[0]():this.stateChanging=0}}get stableStateRetainCount(){return this._stableStateRetainCount}set stableStateRetainCount(e){0==this.stableStateRetainCount&&e>this.stableStateRetainCount?this.stateLock=Symbol():0==e&&e<this.stableStateRetainCount&&(this.stateLock=void 0),this.stateChanging=0,this._stableStateRetainCount=e}get stateChanging(){return this._stateChanging}set stateChanging(e){this._stateChanging=e,e||(this.stableStateListeners.forEach((e=>e[0]())),this.stableStateListeners=[])}teardownLockInfrastructure(){this.stableStateListeners.forEach((([,e])=>e())),this.stableStateListeners=[],this.stateLockQueue.forEach((([,e])=>e())),this.stateLockQueue=[],this.stateLock=void 0,this.stableStateRetainCount=0,this.stateChanging=0}async acquireStateLock(){try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.push([e,t])))}catch(e){return}const e=Symbol();return this.stateLock=e,e}async acquireStateLockWithPriority(){try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.unshift([e,t])))}catch(e){return}const e=Symbol();return this.stateLock=e,e}async forcefullyAcquireStateLock(){this.stableStateListeners.forEach((([,e])=>e())),this.stableStateListeners=[],this.stateLockQueue.forEach((([,e])=>e())),this.stateLockQueue=[];try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.push([e,t])))}catch(e){return}const e=Symbol();return this.stateLock=e,e}releaseStateLock(e){e===this.stateLock&&(this.stateLock=void 0)}async retainStableState(){try{this.stateChanging&&await new Promise(((e,t)=>this.stableStateListeners.push([e,t])))}catch(e){return 0}return this.stableStateRetainCount++,1}releaseStableState(){this.stableStateRetainCount--}get cookieString(){return Object.entries(this.cookies).map((([e,t])=>e+"="+t)).join("; ")}updateCookies(e){let t,s=e.headers["set-cookie"];i(!!s,new n("updateCookies","!!rawHeaders (was undefined)"));let a,r=0;for(;a=/(^.*?)([;=,])/.exec(s);)if(a&&3==a.length)if(s=s.substring(a[0].length).trim(),null==t){if(t=a[1],"="!==a[2])continue}else{if("="===a[2]||r||(this.cookies[t.trim()]=a[1].trim()),t=void 0,","===a[2]){r=0;continue}r=1}}async resetTimeout(){if(!this.loggedIn)return 0;try{const e=await request(`https://${this.provider}/xajax_js.php?pageid=${this.lastVisitedPageId}&id=${this.id}&transid=${this.transId}`,{method:"POST",body:"xajax=reset_timeout",headers:{Cookie:this.cookieString}});this.updateCookies(e)}catch(e){return this.handleLogout(),0}return 1}async sessionTimer(){if(!this.sessionTimerRunning){this.sessionTimerRunning=1;try{do{const e=wait(15e5);this.waitKey=e.waitKey,await e}while(await this.resetTimeout())}catch(e){}this.sessionTimerRunning=0}}stopSessionTimer(){this.waitKey&&cancelWait(this.waitKey),this.waitKey=void 0}async login(){if(this.loggedIn)return;let e=await this.acquireStateLockWithPriority();i(!!e,new s("login","Failed to acquire state lock"));try{if(this.loggedIn)return void this.releaseStateLock(e);let t=await request(`https://${this.provider}/loginto.php`);this.updateCookies(t);const s=DOMObject.parse(t.content).querySelector("#standardformular input[type=hidden][name=loginhash]");i(1==s.length,new n("login",`dom.querySelector('#standardformular input[type=hidden][name=loginhash]').length != 1 (was ${s.length})`));const a=s[0].getAttribute("value");i(!!a,new n("login","loginHash == null || loginHash == '' "+(null!=a?"''":void 0))),t=await request(`https://${this.provider}/index.php`,{method:"POST",body:`login=${encodeURIComponent(this.username)}&passwort=${encodeURIComponent(this.password)}&loginhash=${encodeURIComponent(a)}`,headers:{Cookie:this.cookieString},ignoreStatusCode:1}),this.updateCookies(t),this.verifyPageAndExtractIds(DOMObject.parse(t.content)),this.loggedIn=1,this.lastVisitedPageId=1,this.sessionTimer()}catch(e){throw this.handleLogout(),e}finally{this.releaseStateLock(e)}}async logout(){if(!this.loggedIn)return void this.handleLogout();const e=await this.forcefullyAcquireStateLock();if(!e)return this.teardownLockInfrastructure(),void this.handleLogout();try{await request(`https://${this.provider}/index.php?pageid=9999&id=${this.id}&transid=${this.transId}`,{method:"GET",headers:{Cookie:this.cookieString},ignoreStatusCode:1})}finally{this.handleLogout(),this.releaseStateLock(e)}}handleLogout(){this.id=void 0,this.transId=void 0,this.lastVisitedPageId=void 0,this.visitedPageIds.clear(),this.cookies={},this.loggedIn=0,this.stopSessionTimer()}async fetchPage(e,t=1,n={}){let a,r;i(this.loggedIn,new s("fetchPage","Not logged in")),t?(a=await this.acquireStateLock(),i(!!a,new s("fetchPage","Failed to acquire state lock"))):i(await this.retainStableState(),new s("fetchPage","Failed to retain stable state"));try{r=(await request(`https://${this.provider}/index.php?pageid=${e}&id=${this.id}&transid=${this.transId}${Object.entries(n).map((([e,t])=>`&${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("")}`,{method:"GET",headers:{Cookie:this.cookieString}})).content,t&&this.verifyPageAndExtractIds(DOMObject.parse(r)),this.visitedPageIds.add(e)}catch(e){throw this.handleLogout(),e}finally{t?a&&this.releaseStateLock(a):this.releaseStableState()}return r}}class p{constructor(){this.exceptions=[]}}class u extends p{constructor(){super(...arguments),this.teachers=[]}}class w extends p{constructor(){super(...arguments),this.students=[]}}class g extends p{constructor(){super(...arguments),this.transactions=[]}}class b extends p{constructor(){super(...arguments),this.absences=[],this.absenceReports=[],this.openAbsences=[],this.lateAbsences=[]}}class f extends p{constructor(){super(...arguments),this.subjects=[],this.grades=[]}}const A={parseTeachers(e){const t=new u;try{d(!!e,new n("parseTeachers",`!!content (was ${null!=e?"''":void 0})`));const a=e.trim().replace(/[\r\n]+/g,"\n").split("\n");let i;for(l(a.length>=1,new n("parseTeachers",`lines.length >= 1 (was ${a.length})`)),a.shift();null!=(i=a.shift());)try{i=i.trim();const e=Array.from(i.matchAll(/"(([^"]|"")*)"/g));l(4==e.length,new n("parseTeachers",`matches.length == 4 (was ${e.length})`));for(let t=0;t<e.length;t++)l(!!e[t],new n("parseTeachers",`!!matches[${t}] (was undefined)`)),l(e[t].length>=2,new n("parseTeachers",`matches[${t}].length >= 2 (was ${e[t].length})`)),l("string"==typeof e[t][1],new n("parseTeachers",`typeof matches[${t}][1] === 'string' (was ${typeof e[t][1]})`));const s={};s.id=generateUUID(),s.lastName=e[0][1].trim().replace(/""/g,'"'),s.firstName=e[1][1].trim().replace(/""/g,'"'),s.abbreviation=e[2][1].trim().replace(/""/g,'"'),s.email=e[3][1].trim().replace(/""/g,'"'),t.teachers.push(s)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseTeachers",""+e))}}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseTeachers",""+e))}return t},parseStudents(e){const t=new w;try{d(!!e,new n("parseStudents",`!!content (was ${null!=e?"''":void 0})`));const a=e.trim().replace(/[\r\n]+/g,"\n").split("\n");let i;for(d(!!a,new n("parseStudents",`!!lines (was ${a})`)),l(a.length>0,new n("parseStudents",`lines.length > 0 (was ${a.length})`)),a.shift();null!=(i=a.shift());)try{i=i.trim();const e=Array.from(i.matchAll(/"(([^"]|"")*)"/g));l(12==e.length,new n("parseStudents",`matches.length == 12 (was ${e.length})`));for(let t=0;t<e.length;t++)l(!!e[t],new n("parseStudents",`!!matches[${t}] (was undefined)`)),l(e[t].length>=2,new n("parseStudents",`matches[${t}].length >= 2 (was ${e[t].length})`)),l("string"==typeof e[t][1],new n("parseStudents",`typeof matches[${t}][1] === 'string' (was ${typeof e[t][1]})`));const s={};switch(s.id=generateUUID(),s.lastName=e[0][1].trim().replace(/""/g,'"'),s.firstName=e[1][1].trim().replace(/""/g,'"'),e[2][1].trim().replace(/""/g,'"')){case"m":s.gender="♂";break;case"w":s.gender="♀";break;default:s.gender="⚧"}s.degree=e[3][1].trim().replace(/""/g,'"'),s.bilingual="b"===e[4][1].trim().replace(/""/g,'"'),s.clazz=e[5][1].trim().replace(/""/g,'"'),s.address=e[6][1].trim().replace(/""/g,'"'),s.zip=parseInt(e[7][1].trim().replace(/""/g,'"')),d(!isNaN(s.zip),new n("parseStudents","!isNaN(student.zip) (was NaN)")),s.city=e[8][1].trim().replace(/""/g,'"'),s.phone=e[9][1].trim().replace(/""/g,'"'),s.additionalClass=e[10][1].trim().replace(/""/g,'"'),s.status=e[11][1].trim().replace(/""/g,'"'),t.students.push(s)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseStudents",""+e))}}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseStudents",""+e))}return t},parseTransactions(e){const t=new g;try{let a;d(!!e,new n("parseTransaction",`!!content (was ${null!=e?"''":void 0})`)),a=DOMObject.parse(e),d(!!a,new n("parseTransactions","!!dom (was undefined)"));const i=a.querySelector("#content-card > table");l(!!i,new n("parseTransactions","!!tables (was undefined)")),l(2==i.length,new n("parseTransactions",`tables.length == 2 (was ${i.length})`)),l(!!i[1],new n("parseTransactions","!!tables[1] (was undefined)"));const o=i[1].querySelector("tr");l(!!o,new n("parseTransactions","!!rows (was undefined)")),l(o.length>=2,new n("parseTransactions",`rows.length >= 2 (was ${o.length})`)),o.shift(),o.pop();for(let e=0;e<o.length;e++)o[e]||(o.splice(e,1),e--);for(const e of o)try{const s=e.querySelector("td");l(!!s,new n("parseTransactions","!!fields (was undefined)")),l(4==s.length,new n("parseTransactions",`fields.length == 4 (was ${s.length})`));for(let e=0;e<s.length;e++)l(!!s[e],new n("parseTransactions",`!!fields[${e}] (was undefined)`));const a={};a.id=generateUUID();const r=s[0].innerText()?.trim();l(!!r,new n("parseTransactions",`!!dateHTML (was ${null!=r?"''":void 0})`)),a.date=parseDate(r,"dd.MM.yyyy"),a.reason=s[1].innerText()?.trim(),l(!!a.reason,new n("parseTransactions",`!!transaction.reason (was ${null!=a.reason?"''":void 0})`));const i=s[2].querySelector("span");l(!!i,new n("parseTransactions","!!amountElement (was undefined)")),l(1==i.length,new n("parseTransactions",`amountElement.length == 4 (was ${i.length})`)),l(!!i[0],new n("parseTransactions","!!amountElement[0] (was undefined)"));const o=i[0].innerText()?.trim();l(!!o,new n("parseTransactions",`!!amountHTML (was ${null!=o?"''":void 0})`)),a.amount=parseFloat(o),l(!isNaN(a.amount),new n("parseTransactions","!isNaN(transaction.amount) (was NaN)")),t.transactions.push(a)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseTransactions",""+e))}}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseTransactions",""+e))}return t},parseAbsences(e){const t=new b;try{let a;d(!!e,new n("parseAbsences",`!!content (was ${null!=e?"''":void 0})`)),a=DOMObject.parse(e),d(!!a,new n("parseAbsences","!!dom (was undefined)"));const i=a.querySelector("#uebersicht_bloecke > page > div > table");l(!!i,new n("parseAbsences","!!tables (was undefined)")),l(1==i.length||2==i.length,new n("parseAbsences",`tables.length == 1 || tables.length == 2 (was ${i.length})`));for(let e=0;e<i.length;e++)l(!!i[e],new n("parseAbsences",`!!tables[${e}] (was undefined)`));const o=i[0].querySelector("table.mdl-data-table > tbody > tr");l(!!o,new n("parseAbsences","!!absenceRows (was undefined)")),o.length>0&&o[o.length-1].querySelector("button").length>0&&o.pop(),l(o.length>=3,new n("parseAbsences",`absenceRows.length >= 3 (was ${o.length})`)),l((o.length-3)%2==0,new n("parseAbsences",`(absenceRows.length - 3) % 2 == 0 (was ${o.length})`)),o.shift(),o.pop(),o.pop();for(let e=0;e<o.length;e++)o[e]||(o.splice(e,1),e--);for(let e=0;e<o.length;e++)try{const a=o[e].querySelector("td");l(!!a,new n("parseAbsences","!!absenceFields (was undefined)")),l(7==a.length,new n("parseAbsences",`absenceFields.length == 7 (was ${a.length})`));for(let e=0;e<a.length;e++)l(!!a[e],new n("parseAbsences",`!!absenceFields[${e}] (was undefined)`));const i={};i.id=generateUUID();const c=a[0].innerText()?.trim();l(!!c,new n("parseAbsences",`!!absenceFromDateHTML (was ${null!=c?"''":void 0})`));const d=a[1].innerText()?.trim();l(!!d,new n("parseAbsences",`!!absenceToDateHTML (was ${null!=d?"''":void 0})`)),i.startDate=parseDate(c,"dd.MM.yyyy"),l(!!i.startDate,new n("parseAbsences","!!absence.startDate (was undefined)")),i.endDate=parseDate(d,"dd.MM.yyyy"),l(!!i.endDate,new n("parseAbsences","!!absence.endDate (was undefined)")),i.reason=a[2].innerText()?.trim(),l(null!=i.reason,new n("parseAbsences","absence.reason (was undefined)")),i.additionalInfo=a[3].innerText()?.trim(),l(null!=i.additionalInfo,new n("parseAbsences","absence.additionalInfo (was undefined)")),i.deadline=a[4].innerText()?.trim(),l(null!=i.deadline,new n("parseAbsences","absence.deadline (was undefined)"));const h=a[5].innerText()?.trim();l(null!=h,new n("parseAbsences","excused (was undefined)")),i.excused="Ja"===h;const p=a[6].innerText()?.trim();let u;if(l(null!=p,new n("parseAbsences","lessonCount (was undefined)")),i.lessonCount=parseInt(p),l(!isNaN(i.lessonCount),new n("parseAbsences","!isNaN(absence.lessonCount) (was NaN)")),t.absences.push(i),e+1<o.length&&([u]=o[e+1].querySelector("tr table"))&&u){e++;const a=u.querySelector("tr");l(!!a,new n("parseAbsences","!!absenceReportRows (was undefined)")),l(a.length>=2,new n("parseAbsences",`absenceReportRows.length >= 2 (was ${a.length})`));for(let e=0;e<a.length;e++)l(!!a[e],new n("parseAbsences",`!!absenceReportRows[${e}] (was undefined)`));a.shift(),a.shift();for(let e=0;e<a.length;e++)try{const s=a[e].querySelector("td");l(!!s,new n("parseAbsences","!!absenceReportFields (was undefined)")),l(4==s.length,new n("parseAbsences",`absenceReportFields.length == 7 (was ${s.length})`));for(let e=0;e<s.length;e++)l(!!s[e],new n("parseAbsences",`!!absenceReportFields[${e}] (was undefined)`));const r={};r.id=generateUUID(),r.absenceId=i.id;const o=s[0].innerText()?.trim();l(!!o,new n("parseAbsences",`!!absenceReportDateHTML (was ${null!=o?"''":void 0})`));const c=s[1].innerText()?.trim();l(!!c,new n("parseAbsences",`!!absenceReportTimeHTML (was ${null!=c?"''":void 0})`));const[d,h]=c.split("bis").map((e=>e.trim()));l(!!d,new n("parseAbsences",`!!absenceReportStartTime (was ${null!=d?"''":void 0})`)),l(!!h,new n("parseAbsences",`!!absenceReportEndTime (was ${null!=h?"''":void 0})`)),r.startDate=parseDate(`${o} ${d}`,"dd.MM.yyyy HH:mm"),l(!!r.startDate,new n("parseAbsences","!!absenceReport.startDate (was undefined)")),r.endDate=parseDate(`${o} ${h}`,"dd.MM.yyyy HH:mm"),l(!!r.endDate,new n("parseAbsences","!!absenceReport.endDate (was undefined)")),r.lessonAbbreviation=s[2].innerText()?.trim(),l(null!=r.lessonAbbreviation,new n("parseAbsences","absenceReport.lessonAbbreviation (was undefined)")),r.comment=s[3].innerText()?.trim(),l(null!=r.comment,new n("parseAbsences","absenceReport.comment (was undefined)")),t.absenceReports.push(r)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseAbsences",""+e))}}}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseAbsences",""+e))}const c=a.querySelector("#uebersicht_bloecke > page form > table");l(!!c,new n("parseAbsences","!!openAbsencesTables (was undefined)")),l(1==c.length,new n("parseAbsences",`openAbsencesTables.length == 1 (was ${c.length})`));for(let e=0;e<c.length;e++)l(!!c[e],new n("parseAbsences",`!!openAbsencesTables[${e}] (was undefined)`));const h=c[0].querySelector("tr");l(!!h,new n("parseAbsences","!!openAbsenceRows (was undefined)")),l(h.length>=3,new n("parseAbsences",`openAbsenceRows.length >= 3 (was ${h.length})`)),h.shift(),h.pop(),h.pop();for(let e=0;e<h.length;e++)h[e]||(h.splice(e,1),e--);for(const e of h)try{const s=e.querySelector("td");l(!!s,new n("parseAbsences","!!openAbsenceFields (was undefined)")),l(4==s.length,new n("parseAbsences",`openAbsenceFields.length == 4 (was ${s.length})`));for(let e=0;e<s.length;e++)l(!!s[e],new n("parseAbsences",`!!openAbsenceFields[${e}] (was undefined)`));const a={};a.id=generateUUID();const r=s[0].innerText()?.trim();l(!!r,new n("parseAbsences",`!!openAbsenceDateHTML (was ${null!=r?"''":void 0})`));const i=s[1].innerText()?.trim();l(!!i,new n("parseAbsences",`!!openAbsenceTimeHTML (was ${null!=i?"''":void 0})`)),l(1==Array.from(i.matchAll(/-/g)).length,new n("parseAbsences",`Array.from(openAbsenceTimeHTML.matchAll(/-/g)).length == 1 (was ${Array.from(i.matchAll(/-/g)).length})`));const[o,c]=i.split("-").map((e=>e.trim()));a.startDate=parseDate(`${r} ${o}`,"dd.MM.yyyy HH:mm"),l(!!a.startDate,new n("parseAbsences","!!openAbsence.startDate (was undefined)")),a.endDate=parseDate(`${r} ${c}`,"dd.MM.yyyy HH:mm"),l(!!a.endDate,new n("parseAbsences","!!openAbsence.endDate (was undefined)")),a.lessonAbbreviation=s[2].innerText()?.trim(),l(null!=a.lessonAbbreviation,new n("parseAbsences","openAbsence.lessonAbbreviation (was undefined)")),t.openAbsences.push(a)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseAbsences",""+e))}if(2==i.length){const e=i[1].querySelector("tr");l(!!e,new n("parseAbsences","!!lateAbsenceTableRows (was undefined)")),l(e.length>=3,new n("parseAbsences",`lateAbsenceTableRows.length >= 3 (was ${e.length})`)),e.shift(),e.pop(),e.pop();for(let t=0;t<e.length;t++)e[t]||(e.splice(t,1),t--);for(const a of e)try{const e=a.querySelector("td");l(!!e,new n("parseAbsences","!!lateAbsenceFields (was undefined)")),l(5==e.length,new n("parseAbsences",`lateAbsenceFields.length == 5 (was ${e.length})`));for(let t=0;t<e.length;t++)l(!!e[t],new n("parseAbsences",`!!lateAbsenceFields[${t}] (was undefined)`));const s={};s.id=generateUUID();let r=e[0].innerText()?.replaceAll("(*)","")?.trim();l(!!r,new n("parseAbsences",`!!lateAbsenceDateHTML (was ${null!=r?"''":void 0})`));const i=r.split(",");l(2==i.length,new n("parseAbsences",`commaSeparated.length == 2 (was ${i.length})`)),r=i[1].trim();const o=e[1].innerText()?.trim();l(!!o,new n("parseAbsences",`!!lateAbsenceTimeHTML (was ${null!=o?"''":void 0})`)),s.date=parseDate(`${r} ${o}`,"dd.MM.yyyy HH:mm"),l(!!s.date,new n("parseAbsences","!!lateAbsence.date (was undefined)")),s.reason=e[2].innerText()?.trim(),l(null!=s.reason,new n("parseAbsences","lateAbsence.reason != undefined (was undefined)"));const c=e[3].innerText()?.trim();l(!!c,new n("parseAbsences",`!!timespan (was ${null!=c?"''":void 0})`)),s.timespan=parseInt(c),l(!isNaN(s.timespan),new n("parseAbsences","!isNaN(lateAbsence.timespan) (was NaN)"));const d=e[4].innerText()?.trim();l(!!d,new n("parseAbsences",`!!excused (was ${null!=d?"''":void 0})`)),s.excused="Ja"===d,t.lateAbsences.push(s)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseAbsences",""+e))}}}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseAbsences",""+e))}return t},parseGrades(e){const t=new f;try{let a;d(!!e,new n("parseGrades",`!!content (was ${null!=e?"''":void 0})`)),a=DOMObject.parse(e),d(!!a,new n("parseGrades","!!dom (was undefined)"));const i=a.querySelector("#uebersicht_bloecke > page > div > table > tbody > tr");l(!!i,new n("parseGrades","!!subjectRows (was undefined)")),l(i.length>=1,new n("parseGrades",`subjectRows.length >= 1 (was ${i.length})`));for(let e=0;e<i.length;e++)l(!!i[e],new n("parseGrades",`!!subjectRows[${e}] (was undefined)`));i.shift();for(let e=0;e<i.length;e++)try{const a=i[e].querySelector("td");l(!!a,new n("parseGrades","!!subjectFields (was undefined)")),l(5==a.length,new n("parseGrades",`subjectFields.length == 5 (was ${a.length})`));for(let e=0;e<a.length;e++)l(!!a[e],new n("parseGrades",`!!subjectFields[${e}] (was undefined)`));const o={};o.id=generateUUID();const d=a[0].querySelector("b");l(!!d,new n("parseGrades","!!b (was undefined)")),l(1==d.length,new n("parseGrades",`b.length == 1 (was ${d.length})`));for(let e=0;e<d.length;e++)l(!!d[e],new n("parseGrades",`!!b[${e}] (was undefined)`));o.abbreviation=d[0].innerText()?.trim(),l(null!=o.abbreviation,new n("parseGrades","subject.abbreviation != undefined (was undefined)")),o.name=a[0].innerText()?.trim(),l(null!=o.name,new n("parseGrades","subject.name != undefined (was undefined)")),o.hiddenGrades=a[1].innerText()?.includes("*")??0;const h=a[3].querySelector("a");let p;l(!!h,new n("parseGrades","!!a (was undefined)")),o.gradesConfirmed=0>=h.length,t.subjects.push(o);const u=[];for(;e+1<i.length&&i[e+1].getAttribute("class")?.includes("detailrow");)if(e++,(p=i[e].querySelector("table"))&&1==p.length&&p[0]){const e=p[0].querySelector("tr");l(!!e,new n("parseGrades","!!rows (was undefined)")),u.push(...e)}if(u.length>0){l(u.length>=2,new n("parseGrades",`gradeRows.length >= 2 (was ${u.length})`));for(let e=0;e<u.length;e++)l(!!u[e],new n("parseGrades",`!!gradeRows[${e}] (was undefined)`));u.shift();let e=0,a=0;for(let i=0;i<u.length;i++)try{const s=u[i].querySelector("td");if(l(!!s,new n("parseGrades","!!gradeFields (was undefined)")),2==s.length&&i+1==u.length)continue;l(4==s.length,new n("parseGrades",`gradeFields.length == 4 (was ${s.length})`));for(let e=0;e<s.length;e++)l(!!s[e],new n("parseGrades",`!!gradeFields[${e}] (was undefined)`));const r={};r.id=generateUUID(),r.subjectId=o.id;const d=s[0].innerText()?.trim();d&&(r.date=parseDate(""+d,"dd.MM.yyyy"),c(!!r.date,new n("parseGrades","!!grade.date (was undefined)"))),r.topic=s[1].innerText()?.trim(),l(null!=r.topic,new n("parseGrades","grade.topic (was undefined)"));const h=s[2].innerText()?.trim();r.grade=h?parseFloat(h):void 0,null!=r.grade&&isNaN(r.grade)&&(r.grade=void 0);const p=s[2].querySelector("div");if(p&&1==p.length&&p[0]&&(r.details=p[0].innerText()?.trim()),r.weight=parseFloat(s[3].innerText()?.trim()),l(!isNaN(r.weight),new n("parseGrades","!isNaN(grade.weight) (was NaN)")),r.grade){const t=r.weight??1;e+=r.grade*t,a+=t}t.grades.push(r)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseGrades",""+e))}o.average=a>0?e/a:void 0}e+1<i.length&&i[e+1].getAttribute("id")?.includes("schueleruebersicht_verlauf")&&e++}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseGrades",""+e))}}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("parseGrades",""+e))}return t}};class m extends class{constructor(){this.teachers=[],this.students=[],this.transactions=[],this.absences=[],this.absenceReports=[],this.openAbsences=[],this.lateAbsences=[],this.subjects=[],this.grades=[]}}{constructor(){super(...arguments),this.exceptions=[]}}const y=e=>{const t=new m,n={},i={},c=new Map,d=new Map;for(const t of e.teachers??[])n[t.abbreviation]=t;for(const d of e.subjects??[])try{i[d.abbreviation]=d,c.set(d.id,d),l(!!d.abbreviation,new a("Subjects",`!!subject.abbreviation (was ${null!=d.abbreviation?"''":void 0})`));const[,,e]=d.abbreviation.split("-");l(!!e,new a("Subjects",`!!teacherAbbreviation (was ${null!=e?"''":void 0})`));const t=n[e];if(o(!!t,new a("Subjects","!!teacher (was undefined)")),!t)continue;d.teacherId=t.id,t.subjectIds||(t.subjectIds=[]),t.subjectIds.push(d.id)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("link(Subjects)",""+e))}for(const n of e.grades??[])try{const e=c.get(n.subjectId);if(l(!!e,new a("Grades","!!subject (was undefined)")),!e)continue;e.gradeIds||(e.gradeIds=[]),e.gradeIds.push(n.id)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("link(Grades)",""+e))}for(const n of e.openAbsences??[])try{const e=i[n.lessonAbbreviation];if(o(!!e,new a("OpenAbsences","!!subject (was undefined)")),!e)continue;n.subjectId=e.id,e.openAbsenceIds||(e.openAbsenceIds=[]),e.openAbsenceIds.push(n.id)}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("link(OpenAbsences)",""+e))}for(const t of e.absences??[])d.set(t.id,t);for(const n of e.absenceReports??[])try{const e=i[n.lessonAbbreviation];o(!!e,new a("AbsenceReports","!!subject (was undefined)")),e&&(e.absenceReportIds||(e.absenceReportIds=[]),e.absenceReportIds.push(n.id),n.subjectId=e.id);const t=d.get(n.absenceId);if(l(!!t,new a("AbsenceReports","!!absence (was undefined)")),!t)continue;t.absenceReportIds||(t.absenceReportIds=[]),t.absenceReportIds.push(n.id),n.absenceId=t.id,e&&(t.subjectIds||(t.subjectIds=[]),t.subjectIds.includes(e.id)||(t.subjectIds.push(e.id),e.absenceIds||(e.absenceIds=[]),e.absenceIds.push(t.id)))}catch(e){e instanceof s?t.exceptions.push(e):t.exceptions.push(new r("link(AbsenceReports)",""+e))}return Object.assign(t,e),t};var S;(e=>{e[e.TEACHER=0]="TEACHER",e[e.STUDENT=1]="STUDENT",e[e.TRANSACTION=2]="TRANSACTION",e[e.ABSENCE=3]="ABSENCE",e[e.ABSENCE_REPORT=4]="ABSENCE_REPORT",e[e.OPEN_ABSENCE=5]="OPEN_ABSENCE",e[e.LATE_ABSENCE=6]="LATE_ABSENCE",e[e.SUBJECT=7]="SUBJECT",e[e.GRADE=8]="GRADE"})(S||(S={}));const T={[S.TEACHER]:["lastName","firstName","abbreviation"],[S.STUDENT]:["lastName","firstName"],[S.TRANSACTION]:["date","reason"],[S.ABSENCE]:["startDate","endDate"],[S.ABSENCE_REPORT]:["startDate","endDate","lessonAbbreviation"],[S.OPEN_ABSENCE]:["startDate","endDate","lessonAbbreviation"],[S.LATE_ABSENCE]:["date","reason","timespan"],[S.SUBJECT]:["abbreviation"],[S.GRADE]:["date","topic"]},E=(e,t)=>{if(typeof e!=typeof t)return 0;if(e===t)return 1;if("object"==typeof e&&"object"==typeof t&&e&&t){if(!("$type"in e)||e.$type!=t.$type||typeof e.$type in S||!(e.$type in S))return 0;for(const s of T[e.$type])if(!E(e[s],t[s]))return 0;return 1}return 0},$={[S.TEACHER]:["email"],[S.STUDENT]:["gender","degree","bilingual","clazz","address","zip","city","phone","additionalClass","status"],[S.TRANSACTION]:["amount"],[S.ABSENCE]:["reason","additionalInfo","deadline","excused","lessonCount"],[S.ABSENCE_REPORT]:["comment"],[S.OPEN_ABSENCE]:[],[S.LATE_ABSENCE]:["excused"],[S.SUBJECT]:["name","gradesConfirmed","hiddenGrades"],[S.GRADE]:["grade","details","weight"]},x=(e,t)=>{if(!E(e,t))return 0;if("object"!=typeof e)return 1;for(const s of $[e.$type])if(!x(e[s],t[s]))return 0;return 1};class N{constructor(){this.added=[],this.modified=[],this.removed=[]}}const I=(e,t)=>{const s=new N,n=Array.isArray(e)?[...e]:[e],a=Array.isArray(t)?[...t]:[t];for(let e=0;e<n.length;e++)for(let t=0;t<a.length;t++)if(E(n[e],a[t])){x(n[e],a[t])||s.modified.push([n[e],a[t]]),n.splice(e,1),a.splice(t,1),e--;break}return s.removed=n,s.added=a,s},v={async fetchAbsences(e,s){const n=await e.fetchPage(t.ABSENCES,1,{action:"toggle_abs_showall"});if(!n)return;const a=A.parseAbsences(n);return s&&y({...s,...a}),a},async fetchGrades(e,s){const n=await e.fetchPage(t.GRADES,1);if(!n)return;const a=A.parseGrades(n);return s&&y({...s,...a}),a},async fetchStudents(e,s){await e.fetchPage(t.STUDENTS,1);const n=await e.fetchPage(t.DOCUMENT_DOWNLOAD,0,{tblName:"Kursliste",export_all:1});if(!n)return;const a=A.parseStudents(n);return s&&y({...s,...a}),a},async fetchTeachers(e,s){await e.fetchPage(t.TEACHERS,1);const n=await e.fetchPage(t.DOCUMENT_DOWNLOAD,0,{tblName:"Lehrerliste",export_all:1});if(!n)return;const a=A.parseTeachers(n);return s&&y({...s,...a}),a},async fetchTransactions(e,s){const n=await e.fetchPage(t.TRANSACTIONS,1);if(!n)return;const a=A.parseTransactions(n);return s&&y({...s,...a}),a}};