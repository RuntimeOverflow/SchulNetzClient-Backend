function e(e,t){if(!e)throw new Error(t)}function t(e,t){e||info(t)}function s(e,t){if(!e)throw warn(t),new Error(t)}function n(e,t){if(!e)throw error(t),new Error(t)}function a(e,t){if(!e)throw fatal(t),new Error(t)}var r;!function(e){e[e.ABSENCES=21111]="ABSENCES",e[e.TEACHERS=22352]="TEACHERS",e[e.STUDENTS=22348]="STUDENTS",e[e.TRANSACTIONS=21411]="TRANSACTIONS",e[e.SUBJECTS=22348]="SUBJECTS",e[e.GRADES=21311]="GRADES",e[e.SCHEDULE=22202]="SCHEDULE",e[e.DOCUMENT_DOWNLOAD=1012]="DOCUMENT_DOWNLOAD"}(r||(r={}));class Session{constructor(e,t,s){this.visitedPageIds=new Set,this._loggedIn=!1,this.stateLockQueue=[],this._stableStateRetainCount=0,this.stableStateListeners=[],this._stateChanging=!1,this.cookies={},this.sessionTimerRunning=!1,this.provider=e,this.username=t,this.password=s}verifyPageAndExtractIds(t){try{let s=t.querySelector("#header-menu ul[for=sn-main-menu] > li:nth-child(1) > a");e(1==s.length,"dom.querySelector('#header-menu ul[for=sn-main-menu] > li:nth-child(1) > a').length != 1");let{id:n,transid:a}=extractQueryParameters(s[0].getAttribute("href"),"https://"+this.provider);e(!!n,"id == null || id == ''"),e(!!a,"transid == null || transid == ''"),this.id=n,this.transId=a}catch(e){return warn(`${e}`),!1}return!0}hasVisitedPage(e){return this.visitedPageIds.has(e)}set loggedIn(e){this._loggedIn=e}get loggedIn(){return!!(this._loggedIn&&this.id&&this.transId&&null!=this.lastVisitedPageId)}get stateLock(){return this._stateLock}set stateLock(e){if(this._stateLock=e,e)this.stateChanging=!0;else{let e=this.stateLockQueue.pop();e?e[0]():this.stateChanging=!1}}get stableStateRetainCount(){return this._stableStateRetainCount}set stableStateRetainCount(e){0==this.stableStateRetainCount&&e>this.stableStateRetainCount?this.stateLock=Symbol():0==e&&e<this.stableStateRetainCount&&(this.stateLock=void 0),this.stateChanging=!1,this._stableStateRetainCount=e}get stateChanging(){return this._stateChanging}set stateChanging(e){this._stateChanging=e,e||(this.stableStateListeners.forEach((e=>e[0]())),this.stableStateListeners=[])}teardownLockInfrastructure(){this.stableStateListeners.forEach((([e,t])=>t())),this.stableStateListeners=[],this.stateLockQueue.forEach((([e,t])=>t())),this.stateLockQueue=[],this.stateLock=void 0,this.stableStateRetainCount=0,this.stateChanging=!1}async acquireStateLock(){try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.push([e,t])))}catch(e){return}let e=Symbol();return this.stateLock=e,e}async acquireStateLockWithPriority(){try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.unshift([e,t])))}catch(e){return}let e=Symbol();return this.stateLock=e,e}async forcefullyAcquireStateLock(){this.stableStateListeners.forEach((([e,t])=>t())),this.stableStateListeners=[],this.stateLockQueue.forEach((([e,t])=>t())),this.stateLockQueue=[];try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.push([e,t])))}catch(e){return}let e=Symbol();return this.stateLock=e,e}releaseStateLock(e){e===this.stateLock&&(this.stateLock=void 0)}async retainStableState(){try{this.stateChanging&&await new Promise(((e,t)=>this.stableStateListeners.push([e,t])))}catch(e){return!1}return this.stableStateRetainCount++,!0}releaseStableState(){this.stableStateRetainCount--}get cookieString(){return Object.entries(this.cookies).map((([e,t])=>e+"="+t)).join("; ")}updateCookies(e){if(e.headers["set-cookie"]){let t,s,n=e.headers["set-cookie"],a=!1;for(;s=/(^.*?)([;=,])/.exec(n);)if(s&&3==s.length)if(n=n.substring(s[0].length).trim(),null==t){if(t=s[1],"="!==s[2])continue}else{if("="===s[2]||a||(this.cookies[t.trim()]=s[1].trim()),t=void 0,","===s[2]){a=!1;continue}a=!0}}}async resetTimeout(){if(!this.loggedIn)return!1;try{let e=await request(`https://${this.provider}/xajax_js.php?pageid=${this.lastVisitedPageId}&id=${this.id}&transid=${this.transId}`,{method:"POST",body:"xajax=reset_timeout",headers:{Cookie:this.cookieString}});this.updateCookies(e)}catch(e){return this.handleLogout(),!1}return!0}async sessionTimer(){if(!this.sessionTimerRunning){this.sessionTimerRunning=!0;try{do{let e=wait(15e5);this.waitKey=e.waitKey,await e}while(await this.resetTimeout())}catch(e){}this.sessionTimerRunning=!1}}stopSessionTimer(){this.waitKey&&cancelWait(this.waitKey),this.waitKey=void 0}async login(){if(this.loggedIn)return;let t=await this.acquireStateLockWithPriority();e(!!t,"login(): Failed to acquire state lock"),t=t;try{if(this.loggedIn)return void this.releaseStateLock(t);let s=await request(`https://${this.provider}/loginto.php`);this.updateCookies(s);let n=DOMObject.parse(s.content).querySelector("#standardformular input[type=hidden][name=loginhash]");e(1==n.length,"login(): dom.querySelector('#standardformular input[type=hidden][name=loginhash]').length != 1");let a=n[0].getAttribute("value");e(!!a,"loginHash == null || loginHash == ''"),s=await request(`https://${this.provider}/index.php`,{method:"POST",body:`login=${encodeURIComponent(this.username)}&passwort=${encodeURIComponent(this.password)}&loginhash=${encodeURIComponent(a)}`,headers:{Cookie:this.cookieString},ignoreStatusCode:!0}),this.updateCookies(s),e(this.verifyPageAndExtractIds(DOMObject.parse(s.content)),"login(): verifyPageAndExtractIds() == false"),this.loggedIn=!0,this.lastVisitedPageId=1,this.sessionTimer()}catch(e){throw this.handleLogout(),e}finally{this.releaseStateLock(t)}}async logout(){if(!this.loggedIn)return void this.handleLogout();let e=await this.forcefullyAcquireStateLock();if(!e)return this.teardownLockInfrastructure(),void this.handleLogout();try{await request(`https://${this.provider}/index.php?pageid=9999&id=${this.id}&transid=${this.transId}`,{method:"GET",headers:{Cookie:this.cookieString},ignoreStatusCode:!0})}finally{this.handleLogout(),this.releaseStateLock(e)}}handleLogout(){this.id=void 0,this.transId=void 0,this.lastVisitedPageId=void 0,this.visitedPageIds.clear(),this.cookies={},this.loggedIn=!1,this.stopSessionTimer()}async fetchPage(t,s=!0,n={}){if(!this.loggedIn)return;let a,r;if(s)a=await this.acquireStateLock(),e(!!a,`fetchPage(${t}): Failed to acquire state lock`);else{e(await this.retainStableState(),`fetchPage(${t}): Failed to retain stable state`)}try{r=(await request(`https://${this.provider}/index.php?pageid=${t}&id=${this.id}&transid=${this.transId}${Object.entries(n).map((([e,t])=>`&${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("")}`,{method:"GET",headers:{Cookie:this.cookieString}})).content,s&&this.verifyPageAndExtractIds(DOMObject.parse(r)),this.visitedPageIds.add(t)}catch(e){error(`${e}`),r=void 0,this.handleLogout()}finally{s?a&&this.releaseStateLock(a):this.releaseStableState()}return r}}const i={parseTeachers(e){n(!!e,`parseTeachers: !!content (was ${null!=e?"''":void 0})`);let t=e.trim().replace(/[\r\n]+/g,"\n").split("\n");a(t.length>=1,`parseTeachers: lines.length >= 1 (was ${t.length})`),t.shift();let s,r=[];for(;null!=(s=t.shift());){s=s.trim();const e=Array.from(s.matchAll(/"(([^"]|"")*)"/g));a(4==e.length,`parseTeachers: matches.length == 4 (was ${e.length})`);for(let t=0;t<e.length;t++)a(!!e[t],`parseTeachers: !!matches[${t}] (was undefined)`),a(e[t].length>=2,`parseTeachers: matches[${t}].length >= 2 (was ${e[t].length})`),a("string"==typeof e[t][1],`parseTeachers: typeof matches[${t}][1] === 'string' (was ${typeof e[t][1]})`);let t={};t.id=generateUUID(),t.lastName=e[0][1].trim().replace(/""/g,'"'),t.firstName=e[1][1].trim().replace(/""/g,'"'),t.abbreviation=e[2][1].trim().replace(/""/g,'"'),t.email=e[3][1].trim().replace(/""/g,'"'),r.push(t)}return{teachers:r}},parseStudents(e){n(!!e,`parseCourseParticipants: !!content (was ${null!=e?"''":void 0})`);let t=e.trim().replace(/[\r\n]+/g,"\n").split("\n");n(!!t,`parseCourseParticipants: !!lines (was ${t})`),a(t.length>0,`parseCourseParticipants: lines.length > 0 (was ${t.length})`),t.shift();let s,r=[];for(;null!=(s=t.shift());){s=s.trim();const e=Array.from(s.matchAll(/"(([^"]|"")*)"/g));a(12==e.length,`parseCourseParticipants: matches.length == 12 (was ${e.length})`);for(let t=0;t<e.length;t++)a(!!e[t],`parseCourseParticipants: !!matches[${t}] (was undefined)`),a(e[t].length>=2,`parseCourseParticipants: matches[${t}].length >= 2 (was ${e[t].length})`),a("string"==typeof e[t][1],`parseCourseParticipants: typeof matches[${t}][1] === 'string' (was ${typeof e[t][1]})`);let t={};switch(t.id=generateUUID(),t.lastName=e[0][1].trim().replace(/""/g,'"'),t.firstName=e[1][1].trim().replace(/""/g,'"'),e[2][1].trim().replace(/""/g,'"')){case"m":t.gender="♂";break;case"w":t.gender="♀";break;default:t.gender="⚧"}t.degree=e[3][1].trim().replace(/""/g,'"'),t.bilingual="b"===e[4][1].trim().replace(/""/g,'"'),t.clazz=e[5][1].trim().replace(/""/g,'"'),t.address=e[6][1].trim().replace(/""/g,'"'),t.zip=parseInt(e[7][1].trim().replace(/""/g,'"')),n(!isNaN(t.zip),"parseCourseParticipants: !isNaN(student.zip) (was NaN)"),t.city=e[8][1].trim().replace(/""/g,'"'),t.phone=e[9][1].trim().replace(/""/g,'"'),t.additionalClass=e[10][1].trim().replace(/""/g,'"'),t.status=e[11][1].trim().replace(/""/g,'"'),r.push(t)}return{students:r}},parseTransactions(e){let t;n(!!e,`parseTransactions: !!content (was ${null!=e?"''":void 0})`);try{t=DOMObject.parse(e)}catch(e){n(!1,`parseTransactions: DOMObject.parse(content) errored (threw '${e}')`)}n(!!t,"parseTransactions: !!dom (was undefined)"),t=t;const s=t.querySelector("#content-card > table");a(!!s,"parseTransactions: !!tables (was undefined)"),a(2==s.length,`parseTransactions: tables.length == 2 (was ${s.length})`),a(!!s[1],"parseTransactions: !!tables[1] (was undefined)");let r=s[1].querySelector("tr");a(!!r,"parseTransactions: !!rows (was undefined)"),a(r.length>=2,`parseTransactions: rows.length >= 2 (was ${r.length})`),r.shift(),r.pop();for(let e=0;e<r.length;e++)r[e]||(r.splice(e,1),e--);let i=[];for(let e of r){let t=e.querySelector("td");a(!!t,"parseTransactions: !!fields (was undefined)"),a(4==t.length,`parseTransactions: fields.length == 4 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseTransactions: !!fields[${e}] (was undefined)`);let s={};s.id=generateUUID();let n=t[0].innerText()?.trim();a(!!n,`parseTransactions: !!dateHTML (was ${null!=n?"''":void 0})`),s.date=parseDate(n,"dd.MM.yyyy"),s.reason=t[1].innerText()?.trim(),a(!!s.reason,`parseTransactions: !!transaction.reason (was ${null!=s.reason?"''":void 0})`);let r=t[2].querySelector("span");a(!!r,"parseTransactions: !!amountElement (was undefined)"),a(1==r.length,`parseTransactions: amountElement.length == 4 (was ${r.length})`),a(!!r[0],"parseTransactions: !!amountElement[0] (was undefined)");let l=r[0].innerText()?.trim();a(!!l,`parseTransactions: !!amountHTML (was ${null!=l?"''":void 0})`),s.amount=parseFloat(l),a(!isNaN(s.amount),"parseTransactions: !isNaN(transaction.amount) (was NaN)"),i.push(s)}return{transactions:i}},parseAbsences(e){let t;n(!!e,`parseAbsences: !!content (was ${null!=e?"''":void 0})`);try{t=DOMObject.parse(e)}catch(e){n(!1,`parseAbsences: DOMObject.parse(content) errored (threw '${e}')`)}n(!!t,"parseAbsences: !!dom (was undefined)"),t=t;const s=t.querySelector("#uebersicht_bloecke > page > div > table");a(!!s,"parseAbsences: !!tables (was undefined)"),a(1==s.length||2==s.length,`parseAbsences: tables.length == 1 || tables.length == 2 (was ${s.length})`);for(let e=0;e<s.length;e++)a(!!s[e],`parseAbsences: !!tables[${e}] (was undefined)`);const r=[],i=[],l=s[0].querySelector("table.mdl-data-table > tbody > tr");a(!!l,"parseAbsences: !!absenceRows (was undefined)"),l.length>0&&l[l.length-1].querySelector("button").length>0&&l.pop(),a(l.length>=3,`parseAbsences: absenceRows.length >= 3 (was ${l.length})`),a((l.length-3)%2==0,`parseAbsences: (absenceRows.length - 3) % 2 == 0 (was ${l.length})`),l.shift(),l.pop(),l.pop();for(let e=0;e<l.length;e++)l[e]||(l.splice(e,1),e--);for(let e=0;e<l.length;e++){let t=l[e].querySelector("td");a(!!t,"parseAbsences: !!absenceFields (was undefined)"),a(7==t.length,`parseAbsences: absenceFields.length == 7 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseAbsences: !!absenceFields[${e}] (was undefined)`);let s={};s.id=generateUUID();let n=t[0].innerText()?.trim();a(!!n,`parseAbsences: !!absenceFromDateHTML (was ${null!=n?"''":void 0})`);let o=t[1].innerText()?.trim();a(!!o,`parseAbsences: !!absenceToDateHTML (was ${null!=o?"''":void 0})`),s.startDate=parseDate(n,"dd.MM.yyyy"),a(!!s.startDate,"parseAbsences: !!absence.startDate (was undefined)"),s.endDate=parseDate(o,"dd.MM.yyyy"),a(!!s.endDate,"parseAbsences: !!absence.endDate (was undefined)"),s.reason=t[2].innerText()?.trim(),a(null!=s.reason,"parseAbsences: absence.reason (was undefined)"),s.additionalInfo=t[3].innerText()?.trim(),a(null!=s.additionalInfo,"parseAbsences: absence.additionalInfo (was undefined)"),s.deadline=t[4].innerText()?.trim(),a(null!=s.deadline,"parseAbsences: absence.deadline (was undefined)");const c=t[5].innerText()?.trim();a(null!=c,"parseAbsences: excused (was undefined)"),s.excused="Ja"===c;const d=t[6].innerText()?.trim();let h;if(a(null!=d,"parseAbsences: lessonCount (was undefined)"),s.lessonCount=parseInt(d),a(!isNaN(s.lessonCount),"parseAbsences: !isNaN(absence.lessonCount) (was NaN)"),r.push(s),e+1<l.length&&([h]=l[e+1].querySelector("tr table"))&&h){e++;let t=h.querySelector("tr");a(!!t,"parseAbsences: !!absenceReportRows (was undefined)"),a(t.length>=2,`parseAbsences: absenceReportRows.length >= 2 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseAbsences: !!absenceReportRows[${e}] (was undefined)`);t.shift(),t.shift();for(let e=0;e<t.length;e++){let n=t[e].querySelector("td");a(!!n,"parseAbsences: !!absenceReportFields (was undefined)"),a(4==n.length,`parseAbsences: absenceReportFields.length == 7 (was ${n.length})`);for(let e=0;e<n.length;e++)a(!!n[e],`parseAbsences: !!absenceReportFields[${e}] (was undefined)`);let r={};r.id=generateUUID(),r.absenceId=s.id;let l=n[0].innerText()?.trim();a(!!l,`parseAbsences: !!absenceReportDateHTML (was ${null!=l?"''":void 0})`);let o=n[1].innerText()?.trim();a(!!o,`parseAbsences: !!absenceReportTimeHTML (was ${null!=o?"''":void 0})`);let[c,d]=o.split("bis").map((e=>e.trim()));a(!!c,`parseAbsences: !!absenceReportStartTime (was ${null!=c?"''":void 0})`),a(!!d,`parseAbsences: !!absenceReportEndTime (was ${null!=d?"''":void 0})`),r.startDate=parseDate(`${l} ${c}`,"dd.MM.yyyy HH:mm"),a(!!r.startDate,"parseAbsences: !!absenceReport.startDate (was undefined)"),r.endDate=parseDate(`${l} ${d}`,"dd.MM.yyyy HH:mm"),a(!!r.endDate,"parseAbsences: !!absenceReport.endDate (was undefined)"),r.lessonAbbreviation=n[2].innerText()?.trim(),a(null!=r.lessonAbbreviation,"parseAbsences: absenceReport.lessonAbbreviation (was undefined)"),r.comment=n[3].innerText()?.trim(),a(null!=r.comment,"parseAbsences: absenceReport.comment (was undefined)"),i.push(r)}}}const o=t.querySelector("#uebersicht_bloecke > page form > table");a(!!o,"parseAbsences: !!openAbsencesTables (was undefined)"),a(1==o.length,`parseAbsences: openAbsencesTables.length == 1 (was ${o.length})`);for(let e=0;e<o.length;e++)a(!!o[e],`parseAbsences: !!openAbsencesTables[${e}] (was undefined)`);const c=[],d=o[0].querySelector("tr");a(!!d,"parseAbsences: !!openAbsenceRows (was undefined)"),a(d.length>=3,`parseAbsences: openAbsenceRows.length >= 3 (was ${d.length})`),d.shift(),d.pop(),d.pop();for(let e=0;e<d.length;e++)d[e]||(d.splice(e,1),e--);for(let e of d){let t=e.querySelector("td");a(!!t,"parseAbsences: !!openAbsenceFields (was undefined)"),a(4==t.length,`parseAbsences: openAbsenceFields.length == 4 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseAbsences: !!openAbsenceFields[${e}] (was undefined)`);let s={};s.id=generateUUID();let n=t[0].innerText()?.trim();a(!!n,`parseAbsences: !!openAbsenceDateHTML (was ${null!=n?"''":void 0})`);let r=t[1].innerText()?.trim();a(!!r,`parseAbsences: !!openAbsenceTimeHTML (was ${null!=r?"''":void 0})`),a(1==Array.from(r.matchAll(/-/g)).length,`parseAbsences: Array.from(openAbsenceTimeHTML.matchAll(/-/g)).length == 1 (was ${Array.from(r.matchAll(/-/g)).length})`);let[i,l]=r.split("-").map((e=>e.trim()));s.startDate=parseDate(`${n} ${i}`,"dd.MM.yyyy HH:mm"),a(!!s.startDate,"parseAbsences: !!openAbsence.startDate (was undefined)"),s.endDate=parseDate(`${n} ${l}`,"dd.MM.yyyy HH:mm"),a(!!s.endDate,"parseAbsences: !!openAbsence.endDate (was undefined)"),s.lessonAbbreviation=t[2].innerText()?.trim(),a(null!=s.lessonAbbreviation,"parseAbsences: openAbsence.lessonAbbreviation (was undefined)"),c.push(s)}const h=[];if(2==s.length){const e=s[1].querySelector("tr");a(!!e,"parseAbsences: !!lateAbsenceTableRows (was undefined)"),a(e.length>=3,`parseAbsences: lateAbsenceTableRows.length >= 3 (was ${e.length})`),e.shift(),e.pop(),e.pop();for(let t=0;t<e.length;t++)e[t]||(e.splice(t,1),t--);for(let t of e){let e=t.querySelector("td");a(!!e,"parseAbsences: !!lateAbsenceFields (was undefined)"),a(5==e.length,`parseAbsences: lateAbsenceFields.length == 5 (was ${e.length})`);for(let t=0;t<e.length;t++)a(!!e[t],`parseAbsences: !!lateAbsenceFields[${t}] (was undefined)`);let s={};s.id=generateUUID();let n=e[0].innerText()?.replaceAll("(*)","")?.trim();a(!!n,`parseAbsences: !!lateAbsenceDateHTML (was ${null!=n?"''":void 0})`);let r=n.split(",");a(2==r.length,`parseAbsences: commaSeparated.length == 2 (was ${r.length})`),n=r[1].trim();let i=e[1].innerText()?.trim();a(!!i,`parseAbsences: !!lateAbsenceTimeHTML (was ${null!=i?"''":void 0})`),s.date=parseDate(`${n} ${i}`,"dd.MM.yyyy HH:mm"),a(!!s.date,"parseAbsences: !!lateAbsence.date (was undefined)"),s.reason=e[2].innerText()?.trim(),a(null!=s.reason,"parseAbsences: lateAbsence.reason != undefined (was undefined)");let l=e[3].innerText()?.trim();a(!!l,`parseAbsences: !!timespan (was ${null!=l?"''":void 0})`),s.timespan=parseInt(l),a(!isNaN(s.timespan),"parseAbsences: !isNaN(lateAbsence.timespan) (was NaN)");let o=e[4].innerText()?.trim();a(!!o,`parseAbsences: !!excused (was ${null!=o?"''":void 0})`),s.excused="Ja"===o,h.push(s)}}return{absences:r,absenceReports:i,openAbsences:c,lateAbsences:h}},parseGrades(e){let t;n(!!e,`parseGrades: !!content (was ${null!=e?"''":void 0})`);try{t=DOMObject.parse(e)}catch(e){n(!1,`parseGrades: DOMObject.parse(content) errored (threw '${e}')`)}n(!!t,"parseGrades: !!dom (was undefined)"),t=t;const r=t.querySelector("#uebersicht_bloecke > page > div > table > tbody > tr");a(!!r,"parseGrades: !!subjectRows (was undefined)"),a(r.length>=1,`parseGrades: subjectRows.length >= 1 (was ${r.length})`);for(let e=0;e<r.length;e++)a(!!r[e],`parseGrades: !!subjectRows[${e}] (was undefined)`);r.shift();const i=[],l=[];for(let e=0;e<r.length;e++){let t=r[e].querySelector("td");a(!!t,"parseGrades: !!subjectFields (was undefined)"),a(5==t.length,`parseGrades: subjectFields.length == 5 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseGrades: !!subjectFields[${e}] (was undefined)`);let n={};n.id=generateUUID();let o=t[0].querySelector("b");a(!!o,"parseGrades: !!b (was undefined)"),a(1==o.length,`parseGrades: b.length == 1 (was ${o.length})`);for(let e=0;e<o.length;e++)a(!!o[e],`parseGrades: !!b[${e}] (was undefined)`);n.abbreviation=o[0].innerText()?.trim(),a(null!=n.abbreviation,"parseGrades: subject.abbreviation != undefined (was undefined)"),n.name=t[0].innerText()?.trim(),a(null!=n.name,"parseGrades: subject.name != undefined (was undefined)");let c,d=t[3].querySelector("a");for(a(!!d,"parseGrades: !!a (was undefined)"),n.gradesConfirmed=d.length<=0,i.push(n);e+1<r.length&&r[e+1].getAttribute("class")?.includes("detailrow");)if(e++,(c=r[e].querySelector("table"))&&1==c.length&&c[0]){let e=c[0].querySelector("tr");a(!!e,"parseGrades: !!gradeRows (was undefined)"),a(e.length>=2,`parseGrades: gradeRows.length >= 2 (was ${e.length})`);for(let t=0;t<e.length;t++)a(!!e[t],`parseGrades: !!gradeRows[${t}] (was undefined)`);e.shift();for(let t=0;t<e.length;t++){let r=e[t].querySelector("td");if(a(!!r,"parseGrades: !!gradeFields (was undefined)"),2==r.length&&t+1==e.length)continue;a(4==r.length,`parseGrades: gradeFields.length == 4 (was ${r.length})`);for(let e=0;e<r.length;e++)a(!!r[e],`parseGrades: !!gradeFields[${e}] (was undefined)`);let i={};i.id=generateUUID(),i.subjectId=n.id;let o=r[0].innerText()?.trim();o&&(i.date=parseDate(`${o}`,"dd.MM.yyyy"),s(!!i.date,"parseGrades: !!grade.date (was undefined)")),i.topic=r[1].innerText()?.trim(),a(null!=i.topic,"parseGrades: grade.topic (was undefined)");const c=r[2].innerText()?.trim();i.grade=c?parseFloat(c):void 0,null!=i.grade&&isNaN(i.grade)&&(i.grade=void 0);let d=r[2].querySelector("div");d&&1==d.length&&d[0]&&(i.details=d[0].innerText()?.trim()),i.weight=parseFloat(r[3].innerText()?.trim()),a(!isNaN(i.weight),"parseGrades: !isNaN(grade.weight) (was NaN)"),l.push(i)}}e+1<r.length&&r[e+1].getAttribute("id")?.includes("schueleruebersicht_verlauf")&&e++}return{subjects:i,grades:l}}},l=e=>{const s={},n={},r=new Map,i=new Map;for(let t of e.teachers)s[t.abbreviation]=t;for(let i of e.subjects){n[i.abbreviation]=i,r.set(i.id,i),a(!!i.abbreviation,`link (subjects): !!subject.abbreviation (was ${null!=i.abbreviation?"''":void 0})`);let[e,l,o]=i.abbreviation.split("-");a(!!o,`link (subjects): !!teacherAbbreviation (was ${null!=o?"''":void 0})`);let c=s[o];t(!!c,"link (subjects): !!teacher (was undefined)"),c&&(i.teacherId=c.id,c.subjectIds||(c.subjectIds=[]),c.subjectIds.push(i.id))}for(let t of e.grades){let e=r.get(t.subjectId);a(!!e,"link (grades): !!subject (was undefined)"),e&&(e.gradeIds||(e.gradeIds=[]),e.gradeIds.push(t.id))}for(let s of e.openAbsences){let e=n[s.lessonAbbreviation];t(!!e,"link (openAbsences): !!subject (was undefined)"),e&&(s.subjectId=e.id,e.openAbsenceIds||(e.openAbsenceIds=[]),e.openAbsenceIds.push(s.id))}for(let t of e.absences)i.set(t.id,t);for(let s of e.absenceReports){let e=n[s.lessonAbbreviation];t(!!e,"link (absenceReports): !!subject (was undefined)"),e&&(e.absenceReportIds||(e.absenceReportIds=[]),e.absenceReportIds.push(s.id),s.subjectId=e.id);let r=i.get(s.absenceId);a(!!r,"link (absenceReports): !!absence (was undefined)"),r&&(r.absenceReportIds||(r.absenceReportIds=[]),r.absenceReportIds.push(s.id),s.absenceId=r.id,e&&(r.subjectIds||(r.subjectIds=[]),r.subjectIds.includes(e.id)||(r.subjectIds.push(e.id),e.absenceIds||(e.absenceIds=[]),e.absenceIds.push(r.id))))}},o={joinAbsence:(e,t)=>{let s=Absence.create(e);t.absences.push(s),s.link()},joinAbsenceReport:(e,t)=>{let s=AbsenceReport.create(e);t.absenceReports.push(s),s.link()},joinOpenAbsence:(e,t)=>{let s=OpenAbsence.create(e);t.openAbsences.push(s),s.link()},joinLateAbsence:(e,t)=>{let s=LateAbsence.create(e);t.lateAbsences.push(s),s.link()},joinSubject:(e,t)=>{let s=Subject.create(e);t.subjects.push(s),s.link()},joinGrade:(e,t)=>{let s=Grade.create(e);t.grades.push(s),s.link()},joinStudent:(e,t)=>{let s=Student.create(e);t.students.push(s),s.link()},joinTeacher:(e,t)=>{let s=Teacher.create(e);t.teachers.push(s),s.link()},joinTransaction:(e,t)=>{let s=Transaction.create(e);t.transactions.push(s),s.link()}};async function run(e,t,s){let n={},a=new Session(e,t,s);await a.login();let c=await a.fetchPage(r.ABSENCES,!0,{action:"toggle_abs_showall"});c&&(n={...n,...i.parseAbsences(c)}),c=await a.fetchPage(r.GRADES,!0),c&&(n={...n,...i.parseGrades(c)}),c=await a.fetchPage(r.TRANSACTIONS,!0),c&&(n={...n,...i.parseTransactions(c)}),await a.fetchPage(r.TEACHERS,!0);let d=await a.fetchPage(r.DOCUMENT_DOWNLOAD,!1,{tblName:"Lehrerliste",export_all:1});d&&(n={...n,...i.parseTeachers(d)}),await a.fetchPage(r.STUDENTS,!0),d=await a.fetchPage(r.DOCUMENT_DOWNLOAD,!1,{tblName:"Kursliste",export_all:1}),d&&(n={...n,...i.parseStudents(d)}),await a.logout(),l(n);let h={absences:[],absenceReports:[],openAbsences:[],lateAbsences:[],subjects:[],grades:[],students:[],teachers:[],transactions:[]};for(let e of n.absences??[])o.joinAbsence(e,h);for(let e of n.absenceReports??[])o.joinAbsenceReport(e,h);for(let e of n.openAbsences??[])o.joinOpenAbsence(e,h);for(let e of n.lateAbsences??[])o.joinLateAbsence(e,h);for(let e of n.subjects??[])o.joinSubject(e,h);for(let e of n.grades??[])o.joinGrade(e,h);for(let e of n.students??[])o.joinStudent(e,h);for(let e of n.teachers??[])o.joinTeacher(e,h);for(let e of n.transactions??[])o.joinTransaction(e,h);return h}