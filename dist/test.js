function e(e,t){if(!e)throw new Error(t)}function t(e,t){e||info(t)}function s(e,t){if(!e)throw warn(t),new Error(t)}function n(e,t){if(!e)throw error(t),new Error(t)}function a(e,t){if(!e)throw fatal(t),new Error(t)}var r;!function(e){e[e.ABSENCES=21111]="ABSENCES",e[e.TEACHERS=22352]="TEACHERS",e[e.STUDENTS=22348]="STUDENTS",e[e.TRANSACTIONS=21411]="TRANSACTIONS",e[e.SUBJECTS=22348]="SUBJECTS",e[e.GRADES=21311]="GRADES",e[e.SCHEDULE=22202]="SCHEDULE",e[e.DOCUMENT_DOWNLOAD=1012]="DOCUMENT_DOWNLOAD"}(r||(r={}));class Session{constructor(e,t,s){this.visitedPageIds=new Set,this._loggedIn=!1,this.stateLockQueue=[],this._stableStateRetainCount=0,this.stableStateListeners=[],this._stateChanging=!1,this.cookies={},this.sessionTimerRunning=!1,this.provider=e,this.username=t,this.password=s}verifyPageAndExtractIds(t){try{const s=t.querySelector("#header-menu ul[for=sn-main-menu] > li:nth-child(1) > a");e(1==s.length,"dom.querySelector('#header-menu ul[for=sn-main-menu] > li:nth-child(1) > a').length != 1");const{id:n,transid:a}=extractQueryParameters(s[0].getAttribute("href"),"https://"+this.provider);e(!!n,"id == null || id == ''"),e(!!a,"transid == null || transid == ''"),this.id=n,this.transId=a}catch(e){return warn(`${e}`),!1}return!0}hasVisitedPage(e){return this.visitedPageIds.has(e)}set loggedIn(e){this._loggedIn=e}get loggedIn(){return!!(this._loggedIn&&this.id&&this.transId&&null!=this.lastVisitedPageId)}get stateLock(){return this._stateLock}set stateLock(e){if(this._stateLock=e,e)this.stateChanging=!0;else{const e=this.stateLockQueue.pop();e?e[0]():this.stateChanging=!1}}get stableStateRetainCount(){return this._stableStateRetainCount}set stableStateRetainCount(e){0==this.stableStateRetainCount&&e>this.stableStateRetainCount?this.stateLock=Symbol():0==e&&e<this.stableStateRetainCount&&(this.stateLock=void 0),this.stateChanging=!1,this._stableStateRetainCount=e}get stateChanging(){return this._stateChanging}set stateChanging(e){this._stateChanging=e,e||(this.stableStateListeners.forEach((e=>e[0]())),this.stableStateListeners=[])}teardownLockInfrastructure(){this.stableStateListeners.forEach((([,e])=>e())),this.stableStateListeners=[],this.stateLockQueue.forEach((([,e])=>e())),this.stateLockQueue=[],this.stateLock=void 0,this.stableStateRetainCount=0,this.stateChanging=!1}async acquireStateLock(){try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.push([e,t])))}catch(e){return}const e=Symbol();return this.stateLock=e,e}async acquireStateLockWithPriority(){try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.unshift([e,t])))}catch(e){return}const e=Symbol();return this.stateLock=e,e}async forcefullyAcquireStateLock(){this.stableStateListeners.forEach((([,e])=>e())),this.stableStateListeners=[],this.stateLockQueue.forEach((([,e])=>e())),this.stateLockQueue=[];try{this.stateLock&&await new Promise(((e,t)=>this.stateLockQueue.push([e,t])))}catch(e){return}const e=Symbol();return this.stateLock=e,e}releaseStateLock(e){e===this.stateLock&&(this.stateLock=void 0)}async retainStableState(){try{this.stateChanging&&await new Promise(((e,t)=>this.stableStateListeners.push([e,t])))}catch(e){return!1}return this.stableStateRetainCount++,!0}releaseStableState(){this.stableStateRetainCount--}get cookieString(){return Object.entries(this.cookies).map((([e,t])=>e+"="+t)).join("; ")}updateCookies(e){if(e.headers["set-cookie"]){let t,s,n=e.headers["set-cookie"],a=!1;for(;s=/(^.*?)([;=,])/.exec(n);)if(s&&3==s.length)if(n=n.substring(s[0].length).trim(),null==t){if(t=s[1],"="!==s[2])continue}else{if("="===s[2]||a||(this.cookies[t.trim()]=s[1].trim()),t=void 0,","===s[2]){a=!1;continue}a=!0}}}async resetTimeout(){if(!this.loggedIn)return!1;try{const e=await request(`https://${this.provider}/xajax_js.php?pageid=${this.lastVisitedPageId}&id=${this.id}&transid=${this.transId}`,{method:"POST",body:"xajax=reset_timeout",headers:{Cookie:this.cookieString}});this.updateCookies(e)}catch(e){return this.handleLogout(),!1}return!0}async sessionTimer(){if(!this.sessionTimerRunning){this.sessionTimerRunning=!0;try{do{const e=wait(15e5);this.waitKey=e.waitKey,await e}while(await this.resetTimeout())}catch(e){}this.sessionTimerRunning=!1}}stopSessionTimer(){this.waitKey&&cancelWait(this.waitKey),this.waitKey=void 0}async login(){if(this.loggedIn)return;let t=await this.acquireStateLockWithPriority();e(!!t,"login(): Failed to acquire state lock"),t=t;try{if(this.loggedIn)return void this.releaseStateLock(t);let s=await request(`https://${this.provider}/loginto.php`);this.updateCookies(s);const n=DOMObject.parse(s.content).querySelector("#standardformular input[type=hidden][name=loginhash]");e(1==n.length,"login(): dom.querySelector('#standardformular input[type=hidden][name=loginhash]').length != 1");const a=n[0].getAttribute("value");e(!!a,"loginHash == null || loginHash == ''"),s=await request(`https://${this.provider}/index.php`,{method:"POST",body:`login=${encodeURIComponent(this.username)}&passwort=${encodeURIComponent(this.password)}&loginhash=${encodeURIComponent(a)}`,headers:{Cookie:this.cookieString},ignoreStatusCode:!0}),this.updateCookies(s);e(this.verifyPageAndExtractIds(DOMObject.parse(s.content)),"login(): verifyPageAndExtractIds() == false"),this.loggedIn=!0,this.lastVisitedPageId=1,this.sessionTimer()}catch(e){throw this.handleLogout(),e}finally{this.releaseStateLock(t)}}async logout(){if(!this.loggedIn)return void this.handleLogout();const e=await this.forcefullyAcquireStateLock();if(!e)return this.teardownLockInfrastructure(),void this.handleLogout();try{await request(`https://${this.provider}/index.php?pageid=9999&id=${this.id}&transid=${this.transId}`,{method:"GET",headers:{Cookie:this.cookieString},ignoreStatusCode:!0})}finally{this.handleLogout(),this.releaseStateLock(e)}}handleLogout(){this.id=void 0,this.transId=void 0,this.lastVisitedPageId=void 0,this.visitedPageIds.clear(),this.cookies={},this.loggedIn=!1,this.stopSessionTimer()}async fetchPage(t,s=!0,n={}){if(!this.loggedIn)return;let a,r;if(s)a=await this.acquireStateLock(),e(!!a,`fetchPage(${t}): Failed to acquire state lock`);else{e(await this.retainStableState(),`fetchPage(${t}): Failed to retain stable state`)}try{r=(await request(`https://${this.provider}/index.php?pageid=${t}&id=${this.id}&transid=${this.transId}${Object.entries(n).map((([e,t])=>`&${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("")}`,{method:"GET",headers:{Cookie:this.cookieString}})).content,s&&this.verifyPageAndExtractIds(DOMObject.parse(r)),this.visitedPageIds.add(t)}catch(e){error(`${e}`),r=void 0,this.handleLogout()}finally{s?a&&this.releaseStateLock(a):this.releaseStableState()}return r}}const i={parseTeachers(e){n(!!e,`parseTeachers: !!content (was ${null!=e?"''":void 0})`);const t=e.trim().replace(/[\r\n]+/g,"\n").split("\n");a(t.length>=1,`parseTeachers: lines.length >= 1 (was ${t.length})`),t.shift();const s=[];let r;for(;null!=(r=t.shift());){r=r.trim();const e=Array.from(r.matchAll(/"(([^"]|"")*)"/g));a(4==e.length,`parseTeachers: matches.length == 4 (was ${e.length})`);for(let t=0;t<e.length;t++)a(!!e[t],`parseTeachers: !!matches[${t}] (was undefined)`),a(e[t].length>=2,`parseTeachers: matches[${t}].length >= 2 (was ${e[t].length})`),a("string"==typeof e[t][1],`parseTeachers: typeof matches[${t}][1] === 'string' (was ${typeof e[t][1]})`);const t={};t.id=generateUUID(),t.lastName=e[0][1].trim().replace(/""/g,'"'),t.firstName=e[1][1].trim().replace(/""/g,'"'),t.abbreviation=e[2][1].trim().replace(/""/g,'"'),t.email=e[3][1].trim().replace(/""/g,'"'),s.push(t)}return{teachers:s}},parseStudents(e){n(!!e,`parseCourseParticipants: !!content (was ${null!=e?"''":void 0})`);const t=e.trim().replace(/[\r\n]+/g,"\n").split("\n");n(!!t,`parseCourseParticipants: !!lines (was ${t})`),a(t.length>0,`parseCourseParticipants: lines.length > 0 (was ${t.length})`),t.shift();const s=[];let r;for(;null!=(r=t.shift());){r=r.trim();const e=Array.from(r.matchAll(/"(([^"]|"")*)"/g));a(12==e.length,`parseCourseParticipants: matches.length == 12 (was ${e.length})`);for(let t=0;t<e.length;t++)a(!!e[t],`parseCourseParticipants: !!matches[${t}] (was undefined)`),a(e[t].length>=2,`parseCourseParticipants: matches[${t}].length >= 2 (was ${e[t].length})`),a("string"==typeof e[t][1],`parseCourseParticipants: typeof matches[${t}][1] === 'string' (was ${typeof e[t][1]})`);const t={};switch(t.id=generateUUID(),t.lastName=e[0][1].trim().replace(/""/g,'"'),t.firstName=e[1][1].trim().replace(/""/g,'"'),e[2][1].trim().replace(/""/g,'"')){case"m":t.gender="♂";break;case"w":t.gender="♀";break;default:t.gender="⚧"}t.degree=e[3][1].trim().replace(/""/g,'"'),t.bilingual="b"===e[4][1].trim().replace(/""/g,'"'),t.clazz=e[5][1].trim().replace(/""/g,'"'),t.address=e[6][1].trim().replace(/""/g,'"'),t.zip=parseInt(e[7][1].trim().replace(/""/g,'"')),n(!isNaN(t.zip),"parseCourseParticipants: !isNaN(student.zip) (was NaN)"),t.city=e[8][1].trim().replace(/""/g,'"'),t.phone=e[9][1].trim().replace(/""/g,'"'),t.additionalClass=e[10][1].trim().replace(/""/g,'"'),t.status=e[11][1].trim().replace(/""/g,'"'),s.push(t)}return{students:s}},parseTransactions(e){let t;n(!!e,`parseTransactions: !!content (was ${null!=e?"''":void 0})`);try{t=DOMObject.parse(e)}catch(e){n(!1,`parseTransactions: DOMObject.parse(content) errored (threw '${e}')`)}n(!!t,"parseTransactions: !!dom (was undefined)"),t=t;const s=t.querySelector("#content-card > table");a(!!s,"parseTransactions: !!tables (was undefined)"),a(2==s.length,`parseTransactions: tables.length == 2 (was ${s.length})`),a(!!s[1],"parseTransactions: !!tables[1] (was undefined)");const r=s[1].querySelector("tr");a(!!r,"parseTransactions: !!rows (was undefined)"),a(r.length>=2,`parseTransactions: rows.length >= 2 (was ${r.length})`),r.shift(),r.pop();for(let e=0;e<r.length;e++)r[e]||(r.splice(e,1),e--);const i=[];for(const e of r){const t=e.querySelector("td");a(!!t,"parseTransactions: !!fields (was undefined)"),a(4==t.length,`parseTransactions: fields.length == 4 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseTransactions: !!fields[${e}] (was undefined)`);const s={};s.id=generateUUID();const n=t[0].innerText()?.trim();a(!!n,`parseTransactions: !!dateHTML (was ${null!=n?"''":void 0})`),s.date=parseDate(n,"dd.MM.yyyy"),s.reason=t[1].innerText()?.trim(),a(!!s.reason,`parseTransactions: !!transaction.reason (was ${null!=s.reason?"''":void 0})`);const r=t[2].querySelector("span");a(!!r,"parseTransactions: !!amountElement (was undefined)"),a(1==r.length,`parseTransactions: amountElement.length == 4 (was ${r.length})`),a(!!r[0],"parseTransactions: !!amountElement[0] (was undefined)");const o=r[0].innerText()?.trim();a(!!o,`parseTransactions: !!amountHTML (was ${null!=o?"''":void 0})`),s.amount=parseFloat(o),a(!isNaN(s.amount),"parseTransactions: !isNaN(transaction.amount) (was NaN)"),i.push(s)}return{transactions:i}},parseAbsences(e){let t;n(!!e,`parseAbsences: !!content (was ${null!=e?"''":void 0})`);try{t=DOMObject.parse(e)}catch(e){n(!1,`parseAbsences: DOMObject.parse(content) errored (threw '${e}')`)}n(!!t,"parseAbsences: !!dom (was undefined)"),t=t;const s=t.querySelector("#uebersicht_bloecke > page > div > table");a(!!s,"parseAbsences: !!tables (was undefined)"),a(1==s.length||2==s.length,`parseAbsences: tables.length == 1 || tables.length == 2 (was ${s.length})`);for(let e=0;e<s.length;e++)a(!!s[e],`parseAbsences: !!tables[${e}] (was undefined)`);const r=[],i=[],o=s[0].querySelector("table.mdl-data-table > tbody > tr");a(!!o,"parseAbsences: !!absenceRows (was undefined)"),o.length>0&&o[o.length-1].querySelector("button").length>0&&o.pop(),a(o.length>=3,`parseAbsences: absenceRows.length >= 3 (was ${o.length})`),a((o.length-3)%2==0,`parseAbsences: (absenceRows.length - 3) % 2 == 0 (was ${o.length})`),o.shift(),o.pop(),o.pop();for(let e=0;e<o.length;e++)o[e]||(o.splice(e,1),e--);for(let e=0;e<o.length;e++){const t=o[e].querySelector("td");a(!!t,"parseAbsences: !!absenceFields (was undefined)"),a(7==t.length,`parseAbsences: absenceFields.length == 7 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseAbsences: !!absenceFields[${e}] (was undefined)`);const s={};s.id=generateUUID();const n=t[0].innerText()?.trim();a(!!n,`parseAbsences: !!absenceFromDateHTML (was ${null!=n?"''":void 0})`);const c=t[1].innerText()?.trim();a(!!c,`parseAbsences: !!absenceToDateHTML (was ${null!=c?"''":void 0})`),s.startDate=parseDate(n,"dd.MM.yyyy"),a(!!s.startDate,"parseAbsences: !!absence.startDate (was undefined)"),s.endDate=parseDate(c,"dd.MM.yyyy"),a(!!s.endDate,"parseAbsences: !!absence.endDate (was undefined)"),s.reason=t[2].innerText()?.trim(),a(null!=s.reason,"parseAbsences: absence.reason (was undefined)"),s.additionalInfo=t[3].innerText()?.trim(),a(null!=s.additionalInfo,"parseAbsences: absence.additionalInfo (was undefined)"),s.deadline=t[4].innerText()?.trim(),a(null!=s.deadline,"parseAbsences: absence.deadline (was undefined)");const l=t[5].innerText()?.trim();a(null!=l,"parseAbsences: excused (was undefined)"),s.excused="Ja"===l;const d=t[6].innerText()?.trim();let h;if(a(null!=d,"parseAbsences: lessonCount (was undefined)"),s.lessonCount=parseInt(d),a(!isNaN(s.lessonCount),"parseAbsences: !isNaN(absence.lessonCount) (was NaN)"),r.push(s),e+1<o.length&&([h]=o[e+1].querySelector("tr table"))&&h){e++;const t=h.querySelector("tr");a(!!t,"parseAbsences: !!absenceReportRows (was undefined)"),a(t.length>=2,`parseAbsences: absenceReportRows.length >= 2 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseAbsences: !!absenceReportRows[${e}] (was undefined)`);t.shift(),t.shift();for(let e=0;e<t.length;e++){const n=t[e].querySelector("td");a(!!n,"parseAbsences: !!absenceReportFields (was undefined)"),a(4==n.length,`parseAbsences: absenceReportFields.length == 7 (was ${n.length})`);for(let e=0;e<n.length;e++)a(!!n[e],`parseAbsences: !!absenceReportFields[${e}] (was undefined)`);const r={};r.id=generateUUID(),r.absenceId=s.id;const o=n[0].innerText()?.trim();a(!!o,`parseAbsences: !!absenceReportDateHTML (was ${null!=o?"''":void 0})`);const c=n[1].innerText()?.trim();a(!!c,`parseAbsences: !!absenceReportTimeHTML (was ${null!=c?"''":void 0})`);const[l,d]=c.split("bis").map((e=>e.trim()));a(!!l,`parseAbsences: !!absenceReportStartTime (was ${null!=l?"''":void 0})`),a(!!d,`parseAbsences: !!absenceReportEndTime (was ${null!=d?"''":void 0})`),r.startDate=parseDate(`${o} ${l}`,"dd.MM.yyyy HH:mm"),a(!!r.startDate,"parseAbsences: !!absenceReport.startDate (was undefined)"),r.endDate=parseDate(`${o} ${d}`,"dd.MM.yyyy HH:mm"),a(!!r.endDate,"parseAbsences: !!absenceReport.endDate (was undefined)"),r.lessonAbbreviation=n[2].innerText()?.trim(),a(null!=r.lessonAbbreviation,"parseAbsences: absenceReport.lessonAbbreviation (was undefined)"),r.comment=n[3].innerText()?.trim(),a(null!=r.comment,"parseAbsences: absenceReport.comment (was undefined)"),i.push(r)}}}const c=t.querySelector("#uebersicht_bloecke > page form > table");a(!!c,"parseAbsences: !!openAbsencesTables (was undefined)"),a(1==c.length,`parseAbsences: openAbsencesTables.length == 1 (was ${c.length})`);for(let e=0;e<c.length;e++)a(!!c[e],`parseAbsences: !!openAbsencesTables[${e}] (was undefined)`);const l=[],d=c[0].querySelector("tr");a(!!d,"parseAbsences: !!openAbsenceRows (was undefined)"),a(d.length>=3,`parseAbsences: openAbsenceRows.length >= 3 (was ${d.length})`),d.shift(),d.pop(),d.pop();for(let e=0;e<d.length;e++)d[e]||(d.splice(e,1),e--);for(const e of d){const t=e.querySelector("td");a(!!t,"parseAbsences: !!openAbsenceFields (was undefined)"),a(4==t.length,`parseAbsences: openAbsenceFields.length == 4 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseAbsences: !!openAbsenceFields[${e}] (was undefined)`);const s={};s.id=generateUUID();const n=t[0].innerText()?.trim();a(!!n,`parseAbsences: !!openAbsenceDateHTML (was ${null!=n?"''":void 0})`);const r=t[1].innerText()?.trim();a(!!r,`parseAbsences: !!openAbsenceTimeHTML (was ${null!=r?"''":void 0})`),a(1==Array.from(r.matchAll(/-/g)).length,`parseAbsences: Array.from(openAbsenceTimeHTML.matchAll(/-/g)).length == 1 (was ${Array.from(r.matchAll(/-/g)).length})`);const[i,o]=r.split("-").map((e=>e.trim()));s.startDate=parseDate(`${n} ${i}`,"dd.MM.yyyy HH:mm"),a(!!s.startDate,"parseAbsences: !!openAbsence.startDate (was undefined)"),s.endDate=parseDate(`${n} ${o}`,"dd.MM.yyyy HH:mm"),a(!!s.endDate,"parseAbsences: !!openAbsence.endDate (was undefined)"),s.lessonAbbreviation=t[2].innerText()?.trim(),a(null!=s.lessonAbbreviation,"parseAbsences: openAbsence.lessonAbbreviation (was undefined)"),l.push(s)}const h=[];if(2==s.length){const e=s[1].querySelector("tr");a(!!e,"parseAbsences: !!lateAbsenceTableRows (was undefined)"),a(e.length>=3,`parseAbsences: lateAbsenceTableRows.length >= 3 (was ${e.length})`),e.shift(),e.pop(),e.pop();for(let t=0;t<e.length;t++)e[t]||(e.splice(t,1),t--);for(const t of e){const e=t.querySelector("td");a(!!e,"parseAbsences: !!lateAbsenceFields (was undefined)"),a(5==e.length,`parseAbsences: lateAbsenceFields.length == 5 (was ${e.length})`);for(let t=0;t<e.length;t++)a(!!e[t],`parseAbsences: !!lateAbsenceFields[${t}] (was undefined)`);const s={};s.id=generateUUID();let n=e[0].innerText()?.replaceAll("(*)","")?.trim();a(!!n,`parseAbsences: !!lateAbsenceDateHTML (was ${null!=n?"''":void 0})`);const r=n.split(",");a(2==r.length,`parseAbsences: commaSeparated.length == 2 (was ${r.length})`),n=r[1].trim();const i=e[1].innerText()?.trim();a(!!i,`parseAbsences: !!lateAbsenceTimeHTML (was ${null!=i?"''":void 0})`),s.date=parseDate(`${n} ${i}`,"dd.MM.yyyy HH:mm"),a(!!s.date,"parseAbsences: !!lateAbsence.date (was undefined)"),s.reason=e[2].innerText()?.trim(),a(null!=s.reason,"parseAbsences: lateAbsence.reason != undefined (was undefined)");const o=e[3].innerText()?.trim();a(!!o,`parseAbsences: !!timespan (was ${null!=o?"''":void 0})`),s.timespan=parseInt(o),a(!isNaN(s.timespan),"parseAbsences: !isNaN(lateAbsence.timespan) (was NaN)");const c=e[4].innerText()?.trim();a(!!c,`parseAbsences: !!excused (was ${null!=c?"''":void 0})`),s.excused="Ja"===c,h.push(s)}}return{absences:r,absenceReports:i,openAbsences:l,lateAbsences:h}},parseGrades(e){let t;n(!!e,`parseGrades: !!content (was ${null!=e?"''":void 0})`);try{t=DOMObject.parse(e)}catch(e){n(!1,`parseGrades: DOMObject.parse(content) errored (threw '${e}')`)}n(!!t,"parseGrades: !!dom (was undefined)"),t=t;const r=t.querySelector("#uebersicht_bloecke > page > div > table > tbody > tr");a(!!r,"parseGrades: !!subjectRows (was undefined)"),a(r.length>=1,`parseGrades: subjectRows.length >= 1 (was ${r.length})`);for(let e=0;e<r.length;e++)a(!!r[e],`parseGrades: !!subjectRows[${e}] (was undefined)`);r.shift();const i=[],o=[];for(let e=0;e<r.length;e++){const t=r[e].querySelector("td");a(!!t,"parseGrades: !!subjectFields (was undefined)"),a(5==t.length,`parseGrades: subjectFields.length == 5 (was ${t.length})`);for(let e=0;e<t.length;e++)a(!!t[e],`parseGrades: !!subjectFields[${e}] (was undefined)`);const n={};n.id=generateUUID();const c=t[0].querySelector("b");a(!!c,"parseGrades: !!b (was undefined)"),a(1==c.length,`parseGrades: b.length == 1 (was ${c.length})`);for(let e=0;e<c.length;e++)a(!!c[e],`parseGrades: !!b[${e}] (was undefined)`);n.abbreviation=c[0].innerText()?.trim(),a(null!=n.abbreviation,"parseGrades: subject.abbreviation != undefined (was undefined)"),n.name=t[0].innerText()?.trim(),a(null!=n.name,"parseGrades: subject.name != undefined (was undefined)"),n.hiddenGrades=t[1].innerText()?.includes("*")??!1;const l=t[3].querySelector("a");let d;a(!!l,"parseGrades: !!a (was undefined)"),n.gradesConfirmed=l.length<=0,i.push(n);const h=[];for(;e+1<r.length&&r[e+1].getAttribute("class")?.includes("detailrow");)if(e++,(d=r[e].querySelector("table"))&&1==d.length&&d[0]){const e=d[0].querySelector("tr");a(!!e,"parseGrades: !!rows (was undefined)"),h.push(...e)}if(h.length>0){a(h.length>=2,`parseGrades: gradeRows.length >= 2 (was ${h.length})`);for(let e=0;e<h.length;e++)a(!!h[e],`parseGrades: !!gradeRows[${e}] (was undefined)`);h.shift();let e=0,t=0;for(let r=0;r<h.length;r++){const i=h[r].querySelector("td");if(a(!!i,"parseGrades: !!gradeFields (was undefined)"),2==i.length&&r+1==h.length)continue;a(4==i.length,`parseGrades: gradeFields.length == 4 (was ${i.length})`);for(let e=0;e<i.length;e++)a(!!i[e],`parseGrades: !!gradeFields[${e}] (was undefined)`);const c={};c.id=generateUUID(),c.subjectId=n.id;const l=i[0].innerText()?.trim();l&&(c.date=parseDate(`${l}`,"dd.MM.yyyy"),s(!!c.date,"parseGrades: !!grade.date (was undefined)")),c.topic=i[1].innerText()?.trim(),a(null!=c.topic,"parseGrades: grade.topic (was undefined)");const d=i[2].innerText()?.trim();c.grade=d?parseFloat(d):void 0,null!=c.grade&&isNaN(c.grade)&&(c.grade=void 0);const u=i[2].querySelector("div");if(u&&1==u.length&&u[0]&&(c.details=u[0].innerText()?.trim()),c.weight=parseFloat(i[3].innerText()?.trim()),a(!isNaN(c.weight),"parseGrades: !isNaN(grade.weight) (was NaN)"),c.grade){const s=c.weight??1;e+=c.grade*s,t+=s}o.push(c)}n.average=t>0?e/t:void 0}e+1<r.length&&r[e+1].getAttribute("id")?.includes("schueleruebersicht_verlauf")&&e++}return{subjects:i,grades:o}}},o=e=>{const s={},n={},r=new Map,i=new Map;for(const t of e.teachers??[])s[t.abbreviation]=t;for(const i of e.subjects??[])try{n[i.abbreviation]=i,r.set(i.id,i),a(!!i.abbreviation,`link (subjects): !!subject.abbreviation (was ${null!=i.abbreviation?"''":void 0})`);const[,,e]=i.abbreviation.split("-");a(!!e,`link (subjects): !!teacherAbbreviation (was ${null!=e?"''":void 0})`);const o=s[e];if(t(!!o,"link (subjects): !!teacher (was undefined)"),!o)continue;i.teacherId=o.id,o.subjectIds||(o.subjectIds=[]),o.subjectIds.push(i.id)}catch(e){}for(const t of e.grades??[])try{const e=r.get(t.subjectId);if(a(!!e,"link (grades): !!subject (was undefined)"),!e)continue;e.gradeIds||(e.gradeIds=[]),e.gradeIds.push(t.id)}catch(e){}for(const s of e.openAbsences??[])try{const e=n[s.lessonAbbreviation];if(t(!!e,"link (openAbsences): !!subject (was undefined)"),!e)continue;s.subjectId=e.id,e.openAbsenceIds||(e.openAbsenceIds=[]),e.openAbsenceIds.push(s.id)}catch(e){}for(const t of e.absences??[])i.set(t.id,t);for(const s of e.absenceReports??[])try{const e=n[s.lessonAbbreviation];t(!!e,"link (absenceReports): !!subject (was undefined)"),e&&(e.absenceReportIds||(e.absenceReportIds=[]),e.absenceReportIds.push(s.id),s.subjectId=e.id);const r=i.get(s.absenceId);if(a(!!r,"link (absenceReports): !!absence (was undefined)"),!r)continue;r.absenceReportIds||(r.absenceReportIds=[]),r.absenceReportIds.push(s.id),s.absenceId=r.id,e&&(r.subjectIds||(r.subjectIds=[]),r.subjectIds.includes(e.id)||(r.subjectIds.push(e.id),e.absenceIds||(e.absenceIds=[]),e.absenceIds.push(r.id)))}catch(e){}},c={fetchAbsences:async(e,t)=>{const s=await e.fetchPage(r.ABSENCES,!0,{action:"toggle_abs_showall"});if(!s)return;const n={...t,...i.parseAbsences(s)};return o(n),n},fetchGrades:async(e,t)=>{const s=await e.fetchPage(r.GRADES,!0);if(!s)return;const n={...t,...i.parseGrades(s)};return o(n),n},fetchStudents:async(e,t)=>{await e.fetchPage(r.STUDENTS,!0);const s=await e.fetchPage(r.DOCUMENT_DOWNLOAD,!1,{tblName:"Kursliste",export_all:1});if(!s)return;const n={...t,...i.parseStudents(s)};return o(n),n},fetchTeachers:async(e,t)=>{await e.fetchPage(r.TEACHERS,!0);const s=await e.fetchPage(r.DOCUMENT_DOWNLOAD,!1,{tblName:"Lehrerliste",export_all:1});if(!s)return;const n={...t,...i.parseTeachers(s)};return o(n),n},fetchTransactions:async(e,t)=>{const s=await e.fetchPage(r.TRANSACTIONS,!0);if(!s)return;const n={...t,...i.parseTransactions(s)};return o(n),n}};async function run(e,t,s){let n={};const a=new Session(e,t,s);return await a.login(),n=await c.fetchAbsences(a,n)??n,n=await c.fetchGrades(a,n)??n,n=await c.fetchStudents(a,n)??n,n=await c.fetchTeachers(a,n)??n,n=await c.fetchTransactions(a,n)??n,await a.logout(),n}